//
//  arbor.js - version 0.91
//  a graph vizualization toolkit
//
//  Copyright (c) 2011 Samizdat Drafting Co.
//  Physics code derived from springy.js, copyright (c) 2010 Dennis Hotson
// 
//  Permission is hereby granted, free of charge, to any person
//  obtaining a copy of this software and associated documentation
//  files (the "Software"), to deal in the Software without
//  restriction, including without limitation the rights to use,
//  copy, modify, merge, publish, distribute, sublicense, and/or sell
//  copies of the Software, and to permit persons to whom the
//  Software is furnished to do so, subject to the following
//  conditions:
// 
//  The above copyright notice and this permission notice shall be
//  included in all copies or substantial portions of the Software.
// 
//  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
//  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
//  OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
//  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
//  HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
//  WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
//  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
//  OTHER DEALINGS IN THE SOFTWARE.
//

(function($){

  /*        etc.js */  var trace=function(msg){if(typeof(window)=="undefined"||!window.console){return}var len=arguments.length;var args=[];for(var i=0;i<len;i++){args.push("arguments["+i+"]")}eval("console.log("+args.join(",")+")")};var dirname=function(a){var b=a.replace(/^\/?(.*?)\/?$/,"$1").split("/");b.pop();return"/"+b.join("/")};var basename=function(b){var c=b.replace(/^\/?(.*?)\/?$/,"$1").split("/");var a=c.pop();if(a==""){return null}else{return a}};var _ordinalize_re=/(\d)(?=(\d\d\d)+(?!\d))/g;var ordinalize=function(a){var b=""+a;if(a<11000){b=(""+a).replace(_ordinalize_re,"$1,")}else{if(a<1000000){b=Math.floor(a/1000)+"k"}else{if(a<1000000000){b=(""+Math.floor(a/1000)).replace(_ordinalize_re,"$1,")+"m"}}}return b};var nano=function(a,b){return a.replace(/\{([\w\-\.]*)}/g,function(f,c){var d=c.split("."),e=b[d.shift()];$.each(d,function(){if(e.hasOwnProperty(this)){e=e[this]}else{e=f}});return e})};var objcopy=function(a){if(a===undefined){return undefined}if(a===null){return null}if(a.parentNode){return a}switch(typeof a){case"string":return a.substring(0);break;case"number":return a+0;break;case"boolean":return a===true;break;case"function":return a;break}var b=($.isArray(a))?[]:{};$.each(a,function(d,c){b[d]=objcopy(c)});return b};var objmerge=function(d,b){d=d||{};b=b||{};var c=objcopy(d);for(var a in b){c[a]=b[a]}return c};var objcmp=function(e,c,d){if(!e||!c){return e===c}if(typeof e!=typeof c){return false}if(typeof e!="object"){return e===c}else{if($.isArray(e)){if(!($.isArray(c))){return false}if(e.length!=c.length){return false}}else{var h=[];for(var f in e){if(e.hasOwnProperty(f)){h.push(f)}}var g=[];for(var f in c){if(c.hasOwnProperty(f)){g.push(f)}}if(!d){h.sort();g.sort()}if(h.join(",")!==g.join(",")){return false}}var i=true;$.each(e,function(a){var b=objcmp(e[a],c[a]);i=i&&b;if(!i){return false}});return i}};var objkeys=function(b){var a=[];$.each(b,function(d,c){if(b.hasOwnProperty(d)){a.push(d)}});return a};var objcontains=function(c){if(!c||typeof c!="object"){return false}for(var b=1,a=arguments.length;b<a;b++){if(c.hasOwnProperty(arguments[b])){return true}}return false};var uniq=function(b){var a=b.length;var d={};for(var c=0;c<a;c++){d[b[c]]=true}return objkeys(d)};var arbor_path=function(){var a=$("script").map(function(b){var c=$(this).attr("src");if(!c){return}if(c.match(/arbor[^\/\.]*.js|dev.js/)){return c.match(/.*\//)||"/"}});if(a.length>0){return a[0]}else{return null}};
  /*     kernel.js */  var Kernel=function(b){var l=window.location.protocol=="file:"&&navigator.userAgent.toLowerCase().indexOf("chrome")>-1;if(l){trace("disabling web workers: running in chrome from local file")}var a=(window.Worker!==undefined&&!l);var i=null;var c=null;var f=[];f.last=new Date();var m=null;var e=null;var d=null;var h=null;var g=false;var j=false;var k={system:b,tween:null,nodes:{},init:function(){if(typeof(Tween)!="undefined"){c=Tween()}else{if(typeof(arbor.Tween)!="undefined"){c=arbor.Tween()}else{c={busy:function(){return false},tick:function(){return true},to:function(){trace("Please include arbor-tween.js to enable tweens");c.to=function(){};return}}}}k.tween=c;var n=b.parameters();if(a){trace("using web workers");m=setInterval(k.screenUpdate,n.timeout);i=new Worker(arbor_path()+"arbor.js");i.onmessage=k.workerMsg;i.onerror=function(o){trace("physics:",o)};i.postMessage({type:"physics",physics:objmerge(n,{timeout:Math.ceil(n.timeout)})})}else{trace("couldn't use web workers, be careful...");i=Physics(n.dt,n.stiffness,n.repulsion,n.friction,k.system._updateGeometry);k.start()}return k},graphChanged:function(n){if(a){i.postMessage({type:"changes",changes:n})}else{i._update(n)}k.start()},particleModified:function(o,n){if(a){i.postMessage({type:"modify",id:o,mods:n})}else{i.modifyNode(o,n)}k.start()},physicsModified:function(n){if(!isNaN(n.timeout)){if(a){clearInterval(m);m=setInterval(k.screenUpdate,n.timeout)}else{clearInterval(d);d=null}}if(a){i.postMessage({type:"sys",param:n})}else{i.modifyPhysics(n)}k.start()},workerMsg:function(n){switch(n.data.type){case"geometry":k.workerUpdate(n.data);if(b.parameters().terminationFn()){trace("stopping worker");i.postMessage({type:"stop"})}break;case"stopping":j=false;break;default:trace("physics:",n.data)}},_lastPositions:null,workerUpdate:function(n){k._lastPositions=n;k._lastBounds=n.bounds},_lastFrametime:new Date().valueOf(),_lastBounds:null,_currentRenderer:null,screenUpdate:function(){var o=new Date().valueOf();var n=false;if(k._lastPositions!==null){k.system._updateGeometry(k._lastPositions);k._lastPositions=null;n=true}if(c&&c.busy()){n=true}if(k.system._updateBounds(k._lastBounds)){n=true}if(n){var p=k.system.renderer;if(p!==undefined){if(p!==e){p.init(k.system);e=p}if(c){c.tick()}p.redraw();var q=f.last;f.last=new Date();f.push(f.last-q);if(f.length>50){f.shift()}}}},physicsUpdate:function(){if(c){c.tick()}i.tick();var o=k.system._updateBounds();if(c&&c.busy()){o=true}var p=k.system.renderer;var n=new Date();var p=k.system.renderer;if(p!==undefined){if(p!==e){p.init(k.system);e=p}p.redraw({timestamp:n})}var q=f.last;f.last=n;f.push(f.last-q);if(f.length>50){f.shift()}if(b.parameters().terminationFn()){clearInterval(d);d=null;j=false}},fps:function(o){if(o!==undefined){var r=1000/Math.max(1,targetFps);k.physicsModified({timeout:r})}var s=0;for(var q=0,p=f.length;q<p;q++){s+=f[q]}var n=s/Math.max(1,f.length);if(!isNaN(n)){return Math.round(1000/n)}else{return 0}},start:function(n){if(d!==null){return}if(g&&!n){return}g=false;if(a){i.postMessage({type:"start"})}else{h=null;d=setInterval(k.physicsUpdate,k.system.parameters().timeout)}j=true},stop:function(){g=true;if(a){i.postMessage({type:"stop"})}else{if(d!==null){clearInterval(d);d=null}}j=false},isRunning:function(){return j}};return k.init()};
  /*      atoms.js */  var Node=function(a){this._id=_nextNodeId++;this.data=a||{};this._mass=(a.mass!==undefined)?a.mass:1;this._fixed=(a.fixed===true)?true:false;this._p=new Point((typeof(a.x)=="number")?a.x:null,(typeof(a.y)=="number")?a.y:null);delete this.data.x;delete this.data.y;delete this.data.mass;delete this.data.fixed};var _nextNodeId=1;var Edge=function(b,c,a){this._id=_nextEdgeId--;this.source=b;this.target=c;this.length=(a.length!==undefined)?a.length:1;this.data=(a!==undefined)?a:{};delete this.data.length};var _nextEdgeId=-1;var Particle=function(a,b){this.p=a;this.m=b;this.v=new Point(0,0);this.f=new Point(0,0)};Particle.prototype.applyForce=function(a){this.f=this.f.add(a.divide(this.m))};var Spring=function(c,b,d,a){this.point1=c;this.point2=b;this.length=d;this.k=a};Spring.prototype.distanceToParticle=function(a){var c=that.point2.p.subtract(that.point1.p).normalize().normal();var b=a.p.subtract(that.point1.p);return Math.abs(b.x*c.x+b.y*c.y)};var Point=function(a,b){if(a&&a.hasOwnProperty("y")){b=a.y;a=a.x}this.x=a;this.y=b};Point.random=function(a){a=(a!==undefined)?a:5;return new Point(2*a*(Math.random()-0.5),2*a*(Math.random()-0.5))};Point.prototype={exploded:function(){return(isNaN(this.x)||isNaN(this.y))},add:function(a){return new Point(this.x+a.x,this.y+a.y)},subtract:function(a){return new Point(this.x-a.x,this.y-a.y)},multiply:function(a){return new Point(this.x*a,this.y*a)},divide:function(a){return new Point(this.x/a,this.y/a)},magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normal:function(){return new Point(-this.y,this.x)},normalize:function(){return this.divide(this.magnitude())},equals:function(a){return this.y==a.y&&this.x==a.x}};
  /*     system.js */  var ParticleSystem=function(d,r,f,g,v,n,s){var k=[];var i=null;var l=0;var w=null;var o=0.04;var j=[20,20,20,20];var p=null;var q=null;if(typeof r=="object"){var u=r;f=u.friction;d=u.repulsion;v=u.fps;n=u.dt;r=u.stiffness;g=u.gravity;s=u.precision}f=isNaN(f)?0.5:f;d=isNaN(d)?1000:d;v=isNaN(v)?55:v;r=isNaN(r)?600:r;n=isNaN(n)?0.02:n;s=isNaN(s)?0.6:s;g=(g===true);var t=(v!==undefined)?1000/v:1000/50;var a;var m;var x=function(){if(a&&(a.mean+a.max)/2<0.05){if(m===null){m=new Date().valueOf()}return new Date().valueOf()-m>1000}else{m=null}};var b={repulsion:d,stiffness:r,friction:f,dt:n,gravity:g,precision:s,timeout:t,terminationFn:x};var c={renderer:null,tween:null,nodes:{},edges:{},adjacency:{},names:{},kernel:null};var h={parameters:function(y){if(y!==undefined){if(!isNaN(y.precision)){y.precision=Math.max(0,Math.min(1,y.precision))}$.each(b,function(A,z){if(y[A]!==undefined){b[A]=y[A]}});c.kernel.physicsModified(y)}return b},fps:function(y){if(y===undefined){return c.kernel.fps()}else{h.parameters({timeout:1000/(y||50)})}},defaultTerminationFn:x,start:function(){c.kernel.start(true)},stop:function(){c.kernel.stop()},isRunning:function(){return c.kernel.isRunning()},addNode:function(y,A){A=A||{};var B=c.names[y];if(B){B.data=A;return B}else{if(y!=undefined){var z=new Node(A);z.name=y;c.names[y]=z;c.nodes[z._id]=z;k.push({t:"addNode",id:z._id,m:z.mass,p:z.p});h._notify();return z}}},pruneNode:function(z){var y=h.getNode(z);if(typeof(c.nodes[y._id])!=="undefined"){delete c.nodes[y._id];delete c.names[y.name]}$.each(c.edges,function(B,A){if(A.source._id===y._id||A.target._id===y._id){h.pruneEdge(A)}});k.push({t:"dropNode",id:y._id});h._notify()},getNode:function(y){if(y._id!==undefined){return y}else{if(typeof y=="string"||typeof y=="number"){return c.names[y]}}},eachNode:function(y){$.each(c.nodes,function(B,A){if(A._p.x==null||A._p.y==null){return}var z=(w!==null)?h.toScreen(A._p):A._p;y.call(h,A,z)})},addEdge:function(C,D,B){C=h.getNode(C)||h.addNode(C);D=h.getNode(D)||h.addNode(D);B=B||{};var A=new Edge(C,D,B);var E=C._id;var F=D._id;c.adjacency[E]=c.adjacency[E]||{};c.adjacency[E][F]=c.adjacency[E][F]||[];var z=(c.adjacency[E][F].length>0);if(z){$.extend(c.adjacency[E][F].data,A.data);return}else{c.edges[A._id]=A;c.adjacency[E][F].push(A);var y=(A.length!==undefined)?A.length:1;k.push({t:"addSpring",id:A._id,fm:E,to:F,l:y});h._notify()}return A},pruneEdge:function(C){k.push({t:"dropSpring",id:C._id});delete c.edges[C._id];for(var z in c.adjacency){for(var D in c.adjacency[z]){var A=c.adjacency[z][D];for(var B=A.length-1;B>=0;B--){if(c.adjacency[z][D][B]._id===C._id){c.adjacency[z][D].splice(B,1)}}}}h._notify()},getEdges:function(z,y){z=h.getNode(z);y=h.getNode(y);if(!z||!y){return[]}if(typeof(c.adjacency[z._id])!=="undefined"&&typeof(c.adjacency[z._id][y._id])!=="undefined"){return c.adjacency[z._id][y._id]}return[]},getEdgesFrom:function(y){y=h.getNode(y);if(!y){return[]}if(typeof(c.adjacency[y._id])!=="undefined"){var z=[];$.each(c.adjacency[y._id],function(B,A){z=z.concat(A)});return z}return[]},getEdgesTo:function(y){y=h.getNode(y);if(!y){return[]}var z=[];$.each(c.edges,function(B,A){if(A.target==y){z.push(A)}});return z},eachEdge:function(y){$.each(c.edges,function(C,A){var B=c.nodes[A.source._id]._p;var z=c.nodes[A.target._id]._p;if(B.x==null||z.x==null){return}B=(w!==null)?h.toScreen(B):B;z=(w!==null)?h.toScreen(z):z;if(B&&z){y.call(h,A,B,z)}})},prune:function(z){var y={dropped:{nodes:[],edges:[]}};if(z===undefined){$.each(c.nodes,function(B,A){y.dropped.nodes.push(A);h.pruneNode(A)})}else{h.eachNode(function(B){var A=z.call(h,B,{from:h.getEdgesFrom(B),to:h.getEdgesTo(B)});if(A){y.dropped.nodes.push(B);h.pruneNode(B)}})}return y},graft:function(z){var y={added:{nodes:[],edges:[]}};if(z.nodes){$.each(z.nodes,function(B,A){var C=h.getNode(B);if(C){C.data=A}else{y.added.nodes.push(h.addNode(B,A))}c.kernel.start()})}if(z.edges){$.each(z.edges,function(C,A){var B=h.getNode(C);if(!B){y.added.nodes.push(h.addNode(C,{}))}$.each(A,function(G,D){var F=h.getNode(G);if(!F){y.added.nodes.push(h.addNode(G,{}))}var E=h.getEdges(C,G);if(E.length>0){E[0].data=D}else{y.added.edges.push(h.addEdge(C,G,D))}})})}return y},merge:function(z){var y={added:{nodes:[],edges:[]},dropped:{nodes:[],edges:[]}};$.each(c.edges,function(D,C){if((z.edges[C.source.name]===undefined||z.edges[C.source.name][C.target.name]===undefined)){h.pruneEdge(C);y.dropped.edges.push(C)}});var B=h.prune(function(D,C){if(z.nodes[D.name]===undefined){y.dropped.nodes.push(D);return true}});var A=h.graft(z);y.added.nodes=y.added.nodes.concat(A.added.nodes);y.added.edges=y.added.edges.concat(A.added.edges);y.dropped.nodes=y.dropped.nodes.concat(B.dropped.nodes);y.dropped.edges=y.dropped.edges.concat(B.dropped.edges);return y},tweenNode:function(B,y,A){var z=h.getNode(B);if(z){c.tween.to(z,y,A)}},tweenEdge:function(z,y,C,B){if(B===undefined){h._tweenEdge(z,y,C)}else{var A=h.getEdges(z,y);$.each(A,function(D,E){h._tweenEdge(E,C,B)})}},_tweenEdge:function(z,y,A){if(z&&z._id!==undefined){c.tween.to(z,y,A)}},_updateGeometry:function(B){if(B!=undefined){var y=(B.epoch<l);a=B.energy;var C=B.geometry;if(C!==undefined){for(var A=0,z=C.length/3;A<z;A++){var D=C[3*A];if(y&&c.nodes[D]==undefined){continue}c.nodes[D]._p.x=C[3*A+1];c.nodes[D]._p.y=C[3*A+2]}}}},screen:function(y){if(y==undefined){return{size:w,padding:j,step:o}}if(y.size!==undefined){h.screenSize(y.size.width,y.size.height)}if(!isNaN(y.step)){h.screenStep(y.step)}if(y.padding!==undefined){h.screenPadding(y.padding)}},screenSize:function(y,z){w={width:y,height:z};h._updateBounds()},screenPadding:function(B,C,y,z){if($.isArray(B)){trbl=B}else{trbl=[B,C,y,z]}var D=trbl[0];var A=trbl[1];var E=trbl[2];if(A===undefined){trbl=[D,D,D,D]}else{if(E==undefined){trbl=[D,A,D,A]}}j=trbl},screenStep:function(y){o=y},toScreen:function(A){if(!p||!w){return}var z=j||[0,0,0,0];var y=p.bottomright.subtract(p.topleft);var C=z[3]+A.subtract(p.topleft).divide(y.x).x*(w.width-(z[1]+z[3]));var B=z[0]+A.subtract(p.topleft).divide(y.y).y*(w.height-(z[0]+z[2]));return arbor.Point(C,B)},fromScreen:function(C){if(!p||!w){return}var B=j||[0,0,0,0];var A=p.bottomright.subtract(p.topleft);var z=(C.x-B[3])/(w.width-(B[1]+B[3]))*A.x+p.topleft.x;var y=(C.y-B[0])/(w.height-(B[0]+B[2]))*A.y+p.topleft.y;return arbor.Point(z,y)},_updateBounds:function(z){if(w===null){return}if(z){q=z}else{q=h.bounds()}var C=new Point(q.bottomright.x,q.bottomright.y);var B=new Point(q.topleft.x,q.topleft.y);var E=C.subtract(B);var y=B.add(E.divide(2));var A=4;var G=new Point(Math.max(E.x,A),Math.max(E.y,A));q.topleft=y.subtract(G.divide(2));q.bottomright=y.add(G.divide(2));if(!p){if($.isEmptyObject(c.nodes)){return false}p=q;return true}var F=o;_newBounds={bottomright:p.bottomright.add(q.bottomright.subtract(p.bottomright).multiply(F)),topleft:p.topleft.add(q.topleft.subtract(p.topleft).multiply(F))};var D=new Point(p.topleft.subtract(_newBounds.topleft).magnitude(),p.bottomright.subtract(_newBounds.bottomright).magnitude());if(D.x*w.width>1||D.y*w.height>1){p=_newBounds;return true}else{return false}},energy:function(){return a},bounds:function(){var z=null;var y=null;$.each(c.nodes,function(C,B){if(!z){z=new Point(B._p);y=new Point(B._p);return}var A=B._p;if(A.x===null||A.y===null){return}if(A.x>z.x){z.x=A.x}if(A.y>z.y){z.y=A.y}if(A.x<y.x){y.x=A.x}if(A.y<y.y){y.y=A.y}});if(z&&y){return{bottomright:z,topleft:y}}else{return{topleft:new Point(-1,-1),bottomright:new Point(1,1)}}},nearest:function(A){if(w!==null){A=h.fromScreen(A)}var z={node:null,point:null,distance:null};var y=h;$.each(c.nodes,function(E,B){var C=B._p;if(C.x===null||C.y===null){return}var D=C.subtract(A).magnitude();if(z.distance===null||D<z.distance){z={node:B,point:C,distance:D};if(w!==null){z.screenPoint=h.toScreen(C)}}});if(z.node){if(w!==null){z.distance=h.toScreen(z.node.p).subtract(h.toScreen(A)).magnitude()}return z}else{return null}},_notify:function(){if(i===null){l++}else{clearTimeout(i)}i=setTimeout(h._synchronize,20)},_synchronize:function(){if(k.length>0){c.kernel.graphChanged(k);k=[];i=null}}};c.kernel=Kernel(h);c.tween=c.kernel.tween||null;var e=Object.defineProperty||function(A,y,z){z.get&&A.__defineGetter__(y,z.get);z.set&&A.__defineSetter__(y,z.set)};e(Node.prototype,"p",{get:function(){var z=this;var y=new Point();e(y,"x",{get:function(){return z._p.x},set:function(A){c.kernel.particleModified(z._id,{x:A})}});e(y,"y",{get:function(){return z._p.y},set:function(A){c.kernel.particleModified(z._id,{y:A})}});return y},set:function(y){this._p.x=y.x;this._p.y=y.y;c.kernel.particleModified(this._id,{x:y.x,y:y.y})}});e(Node.prototype,"mass",{get:function(){return this._mass},set:function(y){this._mass=y;c.kernel.particleModified(this._id,{m:y})}});e(Node.prototype,"tempMass",{set:function(y){c.kernel.particleModified(this._id,{_m:y})}});e(Node.prototype,"fixed",{get:function(){return this._fixed},set:function(y){this._fixed=y;c.kernel.particleModified(this._id,{f:y?1:0})}});return h};
  /* barnes-hut.js */  var BarnesHutTree=function(){var b=[];var a=0;var e=null;var d=0.5;var c={init:function(g,h,f){d=f;a=0;e=c._newBranch();e.origin=g;e.size=h.subtract(g)},insert:function(j){var f=e;var g=[j];while(g.length){var h=g.shift();var m=h._m||h.m;var p=c._whichQuad(h,f);if(f[p]===undefined){f[p]=h;f.mass+=m;if(f.p){f.p=f.p.add(h.p.multiply(m))}else{f.p=h.p.multiply(m)}}else{if("origin" in f[p]){f.mass+=(m);if(f.p){f.p=f.p.add(h.p.multiply(m))}else{f.p=h.p.multiply(m)}f=f[p];g.unshift(h)}else{var l=f.size.divide(2);if(l.magnitude()==0){return}var n=new Point(f.origin);if(p[0]=="s"){n.y+=l.y}if(p[1]=="e"){n.x+=l.x}var o=f[p];f[p]=c._newBranch();f[p].origin=n;f[p].size=l;f.mass=m;f.p=h.p.multiply(m);f=f[p];if(o.p.x===h.p.x&&o.p.y===h.p.y){var k=l.x*0.08;var i=l.y*0.08;o.p.x=Math.min(n.x+l.x,Math.max(n.x,o.p.x-k/2+Math.random()*k));o.p.y=Math.min(n.y+l.y,Math.max(n.y,o.p.y-i/2+Math.random()*i))}g.push(o);g.unshift(h)}}}},applyForces:function(m,g){var f=[e];while(f.length){node=f.shift();if(node===undefined){continue}if(m===node){continue}if("f" in node){var k=m.p.subtract(node.p);var l=Math.max(1,k.magnitude());var i=((k.magnitude()>0)?k:Point.random(1)).normalize();m.applyForce(i.multiply(g*(node._m||node.m)).divide(l*l))}else{var j=m.p.subtract(node.p.divide(node.mass)).magnitude();var h=Math.sqrt(node.size.x*node.size.y);if(h/j>d){f.push(node.ne);f.push(node.nw);f.push(node.se);f.push(node.sw)}else{var k=m.p.subtract(node.p.divide(node.mass));var l=Math.max(1,k.magnitude());var i=((k.magnitude()>0)?k:Point.random(1)).normalize();m.applyForce(i.multiply(g*(node.mass)).divide(l*l))}}}},_whichQuad:function(i,f){if(i.p.exploded()){return null}var h=i.p.subtract(f.origin);var g=f.size.divide(2);if(h.y<g.y){if(h.x<g.x){return"nw"}else{return"ne"}}else{if(h.x<g.x){return"sw"}else{return"se"}}},_newBranch:function(){if(b[a]){var f=b[a];f.ne=f.nw=f.se=f.sw=undefined;f.mass=0;delete f.p}else{f={origin:null,size:null,nw:undefined,ne:undefined,sw:undefined,se:undefined,mass:0};b[a]=f}a++;return f}};return c};
  /*    physics.js */  var Physics=function(a,m,n,e,h){var f=BarnesHutTree();var c={particles:{},springs:{}};var l={particles:{}};var o=[];var k=[];var d=0;var b={sum:0,max:0,mean:0};var g={topleft:new Point(-1,-1),bottomright:new Point(1,1)};var j=1000;var i={stiffness:(m!==undefined)?m:1000,repulsion:(n!==undefined)?n:600,friction:(e!==undefined)?e:0.3,gravity:false,dt:(a!==undefined)?a:0.02,theta:0.4,init:function(){return i},modifyPhysics:function(p){$.each(["stiffness","repulsion","friction","gravity","dt","precision"],function(r,s){if(p[s]!==undefined){if(s=="precision"){i.theta=1-p[s];return}i[s]=p[s];if(s=="stiffness"){var q=p[s];$.each(c.springs,function(u,t){t.k=q})}}})},addNode:function(v){var u=v.id;var r=v.m;var t=null;if("p" in v&&v.p.x&&v.p.y){t=new Point(v.p)}else{var q=g.bottomright.x-g.topleft.x;var s=g.bottomright.y-g.topleft.y;t=new Point(g.topleft.x+q*Math.random(),g.topleft.y+s*Math.random())}c.particles[u]=new Particle(t,r);c.particles[u].connections=0;l.particles[u]=c.particles[u];o.push(c.particles[u])},dropNode:function(s){var r=s.id;var q=c.particles[r];var p=$.inArray(q,o);if(p>-1){o.splice(p,1)}delete c.particles[r];delete l.particles[r]},modifyNode:function(r,p){if(r in c.particles){var q=c.particles[r];if("x" in p){q.p.x=p.x}if("y" in p){q.p.y=p.y}if("m" in p){q.m=p.m}if("f" in p){q.fixed=(p.f===1)}if("_m" in p){if(q._m===undefined){q._m=q.m}q.m=p._m}}},addSpring:function(t){var s=t.id;var p=t.l;var r=c.particles[t.fm];var q=c.particles[t.to];if(r!==undefined&&q!==undefined){c.springs[s]=new Spring(r,q,p,i.stiffness);k.push(c.springs[s]);r.connections++;q.connections++;delete l.particles[t.fm];delete l.particles[t.to]}},dropSpring:function(s){var r=s.id;var q=c.springs[r];q.point1.connections--;q.point2.connections--;var p=$.inArray(q,k);if(p>-1){k.splice(p,1)}delete c.springs[r]},_update:function(p){d++;$.each(p,function(q,r){if(r.t in i){i[r.t](r)}});return d},tick:function(){i.tendParticles();i.eulerIntegrator(i.dt);i.tock()},tock:function(){var p=[];$.each(c.particles,function(r,q){p.push(r);p.push(q.p.x);p.push(q.p.y)});if(h){h({geometry:p,epoch:d,energy:b,bounds:g})}},tendParticles:function(){$.each(c.particles,function(q,p){if(p._m!==undefined){if(Math.abs(p.m-p._m)<1){p.m=p._m;delete p._m}else{p.m*=0.98}}p.v.x=p.v.y=0})},eulerIntegrator:function(p){if(i.repulsion>0){if(i.theta>0){i.applyBarnesHutRepulsion()}else{i.applyBruteForceRepulsion()}}if(i.stiffness>0){i.applySprings()}i.applyCenterDrift();if(i.gravity){i.applyCenterGravity()}i.updateVelocity(p);i.updatePosition(p)},applyBruteForceRepulsion:function(){$.each(c.particles,function(q,p){$.each(c.particles,function(s,r){if(p!==r){var u=p.p.subtract(r.p);var v=Math.max(1,u.magnitude());var t=((u.magnitude()>0)?u:Point.random(1)).normalize();p.applyForce(t.multiply(i.repulsion*(r._m||r.m)*0.5).divide(v*v*0.5));r.applyForce(t.multiply(i.repulsion*(p._m||p.m)*0.5).divide(v*v*-0.5))}})})},applyBarnesHutRepulsion:function(){if(!g.topleft||!g.bottomright){return}var q=new Point(g.bottomright);var p=new Point(g.topleft);f.init(p,q,i.theta);$.each(c.particles,function(s,r){f.insert(r)});$.each(c.particles,function(s,r){f.applyForces(r,i.repulsion)})},applySprings:function(){$.each(c.springs,function(t,p){var s=p.point2.p.subtract(p.point1.p);var q=p.length-s.magnitude();var r=((s.magnitude()>0)?s:Point.random(1)).normalize();p.point1.applyForce(r.multiply(p.k*q*-0.5));p.point2.applyForce(r.multiply(p.k*q*0.5))})},applyCenterDrift:function(){var q=0;var r=new Point(0,0);$.each(c.particles,function(t,s){r.add(s.p);q++});if(q==0){return}var p=r.divide(-q);$.each(c.particles,function(t,s){s.applyForce(p)})},applyCenterGravity:function(){$.each(c.particles,function(r,p){var q=p.p.multiply(-1);p.applyForce(q.multiply(i.repulsion/100))})},updateVelocity:function(p){$.each(c.particles,function(t,q){if(q.fixed){q.v=new Point(0,0);q.f=new Point(0,0);return}var s=q.v.magnitude();q.v=q.v.add(q.f.multiply(p)).multiply(1-i.friction);q.f.x=q.f.y=0;var r=q.v.magnitude();if(r>j){q.v=q.v.divide(r*r)}})},updatePosition:function(q){var r=0,p=0,u=0;var t=null;var s=null;$.each(c.particles,function(w,v){v.p=v.p.add(v.v.multiply(q));var x=v.v.magnitude();var z=x*x;r+=z;p=Math.max(z,p);u++;if(!t){t=new Point(v.p.x,v.p.y);s=new Point(v.p.x,v.p.y);return}var y=v.p;if(y.x===null||y.y===null){return}if(y.x>t.x){t.x=y.x}if(y.y>t.y){t.y=y.y}if(y.x<s.x){s.x=y.x}if(y.y<s.y){s.y=y.y}});b={sum:r,max:p,mean:r/u,n:u};g={topleft:s||new Point(-1,-1),bottomright:t||new Point(1,1)}},systemEnergy:function(p){return b}};return i.init()};var _nearParticle=function(b,c){var c=c||0;var a=b.x;var f=b.y;var e=c*2;return new Point(a-c+Math.random()*e,f-c+Math.random()*e)};

  // if called as a worker thread, set up a run loop for the Physics object and bail out
  if (typeof(window)=='undefined') return (function(){
  /* hermetic.js */  $={each:function(d,e){if($.isArray(d)){for(var c=0,b=d.length;c<b;c++){e(c,d[c])}}else{for(var a in d){e(a,d[a])}}},map:function(a,c){var b=[];$.each(a,function(f,e){var d=c(e);if(d!==undefined){b.push(d)}});return b},extend:function(c,b){if(typeof b!="object"){return c}for(var a in b){if(b.hasOwnProperty(a)){c[a]=b[a]}}return c},isArray:function(a){if(!a){return false}return(a.constructor.toString().indexOf("Array")!=-1)},inArray:function(c,a){for(var d=0,b=a.length;d<b;d++){if(a[d]===c){return d}}return -1},isEmptyObject:function(a){if(typeof a!=="object"){return false}var b=true;$.each(a,function(c,d){b=false});return b}};
  /*     worker.js */  var PhysicsWorker=function(){var b=20;var a=null;var c=null;var e=[];var d={init:function(f){d.timeout(f.timeout);a=Physics(f.dt,f.stiffness,f.repulsion,f.friction,d.tock);return d},timeout:function(f){if(f!=b){b=f;if(c!==null){d.stop();d.go()}}},go:function(){if(c!==null){return}c=setInterval(d.tick,b)},stop:function(){if(c===null){return}clearInterval(c);c=null;postMessage({type:"stopping"})},tick:function(){a.tick()},tock:function(f){f.type="geometry";postMessage(f)},modifyNode:function(g,f){a.modifyNode(g,f);d.go()},modifyPhysics:function(f){a.modifyPhysics(f)},update:function(f){var g=a._update(f)}};return d};var physics=PhysicsWorker();onmessage=function(a){if(!a.data.type){postMessage("¿kérnèl?");return}if(a.data.type=="physics"){var b=a.data.physics;physics.init(a.data.physics);return}switch(a.data.type){case"modify":physics.modifyNode(a.data.id,a.data.mods);break;case"changes":physics.update(a.data.changes);physics.go();break;case"start":physics.go();break;case"stop":physics.stop();break;case"sys":var b=a.data.param||{};if(!isNaN(b.timeout)){physics.timeout(b.timeout)}physics.modifyPhysics(b);physics.go();break}};
  })()


  arbor = (typeof(arbor)!=='undefined') ? arbor : {}
  $.extend(arbor, {
    // object constructors (don't use ‘new’, just call them)
    ParticleSystem:ParticleSystem,
    Point:function(x, y){ return new Point(x, y) },

    // immutable object with useful methods
    etc:{      
      trace:trace,              // ƒ(msg) -> safe console logging
      dirname:dirname,          // ƒ(path) -> leading part of path
      basename:basename,        // ƒ(path) -> trailing part of path
      ordinalize:ordinalize,    // ƒ(num) -> abbrev integers (and add commas)
      objcopy:objcopy,          // ƒ(old) -> clone an object
      objcmp:objcmp,            // ƒ(a, b, strict_ordering) -> t/f comparison
      objkeys:objkeys,          // ƒ(obj) -> array of all keys in obj
      objmerge:objmerge,        // ƒ(dst, src) -> like $.extend but non-destructive
      uniq:uniq,                // ƒ(arr) -> array of unique items in arr
      arbor_path:arbor_path     // ƒ() -> guess the directory of the lib code
    }
  })
  
})(this.jQuery)